name: Docker Build (GHCR)

on:
  push:
    paths-ignore:
      - "**.md"
    branches:
      - dev # mainly for testing rn

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get branch names
        id: branch-name
        uses: tj-actions/branch-names@v5.4

      - name: Prepare
        id: prep
        run: |
          DOCKER_IMAGE=ghcr.io/no767/rin
          VERSION=v2.2.0-dev
          SHORTREF=${GITHUB_SHA::8}
        
          if [ ${{ steps.branch-name.outputs.current_branch }} == master ]; then
            # If this is git tag, use the tag name as a docker tag
            if [[ $GITHUB_REF == refs/tags/* ]]; then
              VERSION=${GITHUB_REF#refs/tags/v}
              TAGS="${DOCKER_IMAGE}:${VERSION}"
            fi
          elif [ ${{ steps.branch-name.outputs.current_branch }} == dev ]; then
            if [[ $VERSION =~ ^v[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\-(dev)$ ]]; then
              TAGS="${VERSION}-${SHORTREF}"
            fi
          fi

          # Allow for the semver to be appended by the commit sha. 
          # this is the preffered way to tag dev builds
          
          # Set output parameters
          echo ::set-output name=tags::${TAGS}
          echo ::set-output name=docker_image::${DOCKER_IMAGE}

      - name: Setup Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Docker layers
        uses: actions/cache@v2
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ steps.prep.outputs.tags }}
          cache-from: type=local,src=/tmp/.buildx-cache-v2
          cache-to: type=local,dest=/tmp/.buildx-cache-new-v2

      - name: Move Cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache
