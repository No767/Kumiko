Consolidate utilities and align towards stricter ruff rules